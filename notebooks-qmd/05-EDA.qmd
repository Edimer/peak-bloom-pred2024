---
title: "International Cherry Blossom Prediction Competition"
subtitle: "Exploratory Data Analysis"
author: "Edimer David Jaramillo"
date: "`r lubridate::now()`"
lang: en-US
format:
  html:
    page-layout: article
    toc: true
    code-fold: true
    df-print: paged
    toc-location: left
    number-depth: 4
    theme: yeti
    code-copy: true
    highlight-style: github
    embed-resources: true
    code-tools:
      source: true    
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      error = FALSE, 
                      message = FALSE,
                      fig.align = 'center')
```

# Libraries and setup

```{r}
library(tidyverse)
library(arrow)
library(splines)

theme_set(theme_bw() + theme(legend.position = "top"))
```

# Data

- Extraigo una variable de nombre `country` que tiene el país, esto lo hago con la finalidad de evaluar patrones de comportamiento por diferentes países y porque podría ser de ayuda para extrapolar a regiones donde no tenemos registros históricos de floración.

```{r}
df_full <- read_parquet("../external-data/df_full.parquet") |> 
  mutate(
    country = 
      case_when(
        str_detect(location, "Japan") ~ "Japan",
        str_detect(location, "kyoto") ~ "Japan",
        str_detect(location, "liestal") ~ "Switzerland",
        str_detect(location, "Switzerland") ~ "Switzerland",
        str_detect(location, "South Korea") ~ "South Korea",
        str_detect(location, "vancouver") ~ "Canada",
        str_detect(location, "washingtondc") ~ "USA",
      )
  ) |> 
  relocate(location, country, everything())

df_weather <- read_parquet("../external-data/df_weather.parquet")

df_photop <- read_parquet("../external-data/df_photoperiod.parquet")
```

# DOY distribution by country

```{r}
#| fig-width: 7
#| fig-height: 5.5
#| layout-nrow: 1
#| column: screen-inset-shaded

df_full |> 
  ggplot(aes(x = bloom_doy)) +
  facet_wrap(~country, ncol = 1, scales = "free_y") +
  geom_histogram(color = "black") +
  geom_rug() +
  labs(x = "Bloom DOY", y = "Count",
       title = "DOY distribution by country",
       subtitle = "Original scale")

df_full |> 
  ggplot(aes(x = bloom_doy)) +
  facet_wrap(~country, ncol = 1, scales = "free_y") +
  geom_histogram(color = "black") +
  geom_rug() +
  scale_x_log10() +
  labs(x = "Bloom DOY", y = "Count",
       title = "DOY distribution by country",
       subtitle = "Logarithmic scale")
```

# Scatter plot of all vs DOY

::: {.panel-tabset}

## Japan

```{r}
#| fig-width: 9
#| fig-height: 16
#| fig-align: center
#| column: page-inset-right
df_full |> 
  filter(country == "Japan") |> 
  select(-c(location, country, lat, long, alt, year, bloom_date)) |> 
  pivot_longer(cols = -bloom_doy) |> 
  ggplot(aes(x = value, y = bloom_doy)) +
  facet_wrap(~name, scales = "free", ncol = 4) +
  geom_bin_2d(show.legend = FALSE) +
  scale_x_log10() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_smooth(method = "gam",
              formula = y ~ ns(x, df = 2),
              color = "firebrick",
              se = FALSE) +
  labs(y = "DOY", x = "", title = "Japan")
```

## Switzerland

```{r}
#| fig-width: 9
#| fig-height: 16
#| fig-align: center
#| column: page-inset-right
df_full |> 
  filter(country == "Switzerland") |> 
  select(-c(location, country, lat, long, alt, year, bloom_date)) |> 
  pivot_longer(cols = -bloom_doy) |> 
  ggplot(aes(x = value, y = bloom_doy)) +
  facet_wrap(~name, scales = "free", ncol = 4) +
  geom_bin_2d(show.legend = FALSE) +
  scale_x_log10() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_smooth(method = "gam",
              formula = y ~ ns(x, df = 2),
              color = "firebrick",
              se = FALSE) +
  labs(y = "DOY", x = "", title = "Japan")
```

## South Korea

```{r}
#| fig-width: 9
#| fig-height: 16
#| fig-align: center
#| column: page-inset-right
df_full |> 
  filter(country == "South Korea") |> 
  select(-c(location, country, lat, long, alt, year, bloom_date)) |> 
  pivot_longer(cols = -bloom_doy) |> 
  ggplot(aes(x = value, y = bloom_doy)) +
  facet_wrap(~name, scales = "free", ncol = 4) +
  geom_bin_2d(show.legend = FALSE) +
  scale_x_log10() +
  geom_smooth(method = "lm", se = FALSE) +
  geom_smooth(method = "gam",
              formula = y ~ ns(x, df = 2),
              color = "firebrick",
              se = FALSE) +
  labs(y = "DOY", x = "", title = "Japan")
```


:::
