---
title: "International Cherry Blossom Prediction Competition"
subtitle: "Data integration"
author: "Edimer David Jaramillo"
date: "`r lubridate::now()`"
lang: en-US
format:
  html:
    page-layout: article
    toc: true
    code-fold: true
    df-print: paged
    toc-location: left
    number-depth: 4
    theme: yeti
    code-copy: true
    highlight-style: github
    embed-resources: true
    code-tools:
      source: true    
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      error = FALSE, 
                      message = FALSE,
                      fig.align = 'center')
```

# Libraries and setup

```{r}
library(tidyverse)
library(fs)
library(arrow)

theme_set(theme_bw() + theme(legend.position = "top"))

pattern_japan <- "japan"
pattern_kyoto <- "kyoto"
pattern_liestal <- "liestal"
pattern_meteoswiss <- "meteoswiss"
pattern_vancouver <- "vancouver"
pattern_usa_ny <- "newyork"
pattern_usa_wdc <- "washingtondc"
pattern_southk <- "south"

initial_files <- dir_ls("../data/")

files_cherry <-
  initial_files[!str_detect(initial_files, "USA-NPN|.md")]

files_soilgrids <- dir_ls("../external-data/soilgrids/csv/")

files_other <- dir_ls("../external-data/other/", regexp = ".csv")

files_bioclim <- dir_ls("../external-data/weather/", regexp = "bioclim")

files_weather <- dir_ls("../external-data/weather/", regexp = ".parquet")

files_photoperiod <- dir_ls("../external-data/other-photoperiod/", regexp = ".parquet")

# Data NPN
data_npn1 <- read_csv("../data/USA-NPN_individual_phenometrics_data.csv") |> 
  mutate(Observation_Date = str_c(First_Yes_Month, "-", First_Yes_Day, "-", First_Yes_Year),
         Observation_Date = mdy(Observation_Date),
         location = "NPN",
         year = year(Observation_Date)) |> 
  select(location,
         lat = Latitude, 
         long = Longitude,
         alt = Elevation_in_Meters,
         year,
         bloom_date = Observation_Date,
         bloom_doy = First_Yes_DOY)

data_npn2 <- read_csv("../data/USA-NPN_status_intensity_observations_data.csv") |> 
  mutate(Observation_Date = mdy(Observation_Date),
         location = "NPN",
         year = year(Observation_Date)) |>
  select(location,
         lat = Latitude, 
         long = Longitude,
         alt = Elevation_in_Meters,
         year,
         bloom_date = Observation_Date,
         bloom_doy = Day_of_Year)

data_npn <- bind_rows(data_npn1, data_npn2)
```

# Full data

- To the initial data provided for the competition I add by coordinates (longitude and latitude) the SoilGrids information, the complementary information (*other*) and the bioclimatic variables. Duplicate records are eliminated in this final table. The final table (`df_full`) is exported for further analysis. The total records in this table is 17966. **Note:** I mixed the data only for ease of handling, but I am aware that in the data provided by the *National Phenology Network* there are other types of species.
- Data provided by the *National Phenology Network* is included in the `df_full` table.
- I keep the weather data in a separate database (`df_weather`). There are more than five million records and they have different temporalities.
- I keep photoperiod information in a separate database (`df_photoperiod`).
- I export the three files`df_full`, `df_weather` and `df_photoperiod` in *.parquet* format for further analysis.

```{r}
df_initial_cherry <-
  files_cherry |>
  map(.f = ~ read_csv(.x)) |>
  list_rbind() |> 
  bind_rows(data_npn)

df_soilgrids <-
  files_soilgrids |>
  map(.f = ~ read_csv(.x)) |>
  list_rbind()

df_other <-
  files_other |>
  map(.f = ~ read_csv(.x)) |>
  list_rbind()


names_bioclim <- str_c("bio", 1:19)
df_bioclim <-
  files_bioclim |>
  map(
    .f = function(x = .x) {
      res =
        read_csv(x) |>
        set_names(c("lat", "long", names_bioclim))
      return(res)
    }
  ) |>
  list_rbind()

df_full <-
  df_initial_cherry |>
  left_join(df_soilgrids, by = c("long", "lat")) |>
  left_join(df_other, by = c("long", "lat")) |>
  left_join(df_bioclim, by = c("long", "lat")) |> 
  distinct_all()

write_parquet(df_full, "../external-data/df_full.parquet")

df_full |> head()
```

# Data weather

```{r}
df_weather <-
  files_weather |>
  map(
    .f = function(x = .x) {
      res =
        read_parquet(x)
      return(res)
    }
  ) |>
  list_rbind() |> 
  rename(long = LON,
         lat = LAT)

write_parquet(df_weather, "../external-data/df_weather.parquet")

df_weather |> head()
```

# Data photoperiod

```{r}
df_photoperiod <-
  files_photoperiod |>
  map(
    .f = function(x = .x) {
      res =
        read_parquet(x)
      return(res)
    }
  ) |>
  list_rbind()

write_parquet(df_photoperiod, "../external-data/df_photoperiod.parquet")

df_photoperiod |> head()
```

